<?php

namespace App\Http\Controllers;

use Illuminate\Support\Facades\DB;
use App\Http\Requests\ExploitantStore;
use App\Http\Requests\ExploitantEdit;
use Illuminate\Http\Request;
use App\Models\Exploitant;

class ExploitantController extends Controller
{
    public function index()
    {
        $data = Exploitant::all();
        return view('exploitant.exploitant',compact('data'));
    }
    public function index1()
    {
        $data = Exploitant::all();
        return view('administrateur.exploitant.exploitant',compact('data'));
    }

    public function store(ExploitantStore $request)
    {
            // $input = new Exploitant;
            $exploitant_nom = $request->input('exploitant_nom');
            $cin = $request->input('cin');
            $lieu = $request->input('lieu');

            $exploitant = Exploitant::where('exploitant_nom', $exploitant_nom)->first();
            $cin1 = Exploitant::where('cin', $cin)->first();

            if($exploitant || $cin1){
                return redirect()->back()->withError('veuillez verifier le cin ou le nom ');  
            }
            else{
            Exploitant::insert([
                'exploitant_nom' => $exploitant_nom,
                'cin' => $cin,
                'lieu' => $lieu,
            ]);
            return redirect()->back()->withSuccess('exploitant ajouté avec succès');
        }
    }

    public function delete($id) 
    {
        $autorisation_c = DB::select("SELECT *FROM autorisation_c WHERE exploitant_id= '$id'");
        if($autorisation_c){
            return redirect()->back()->withError('ça ne peut pas être suprimmé!'); 
        }
        Exploitant::destroy($id);
        return redirect()->back()->withSuccess('suppression avec succès');
    }

    public function editPage($id)
    {
        $dataEdit = Exploitant::find($id);
        $data = Exploitant::all();
       return view('exploitant.exploitantEdit',compact('data','dataEdit'));
    }
    public function edit(ExploitantEdit $request)
    {
            $exploitant_nom = $request->input('exploitant_nom');
            $cin = $request->input('cin');
            $lieu = $request->input('lieu');
            $id = $request->input('id');

            $Model = DB::update("UPDATE public.exploitant
            SET  exploitant_nom='$exploitant_nom', cin= '$cin', lieu='$lieu'
            WHERE id ='$id'");
            
           $data = Exploitant::all();
           return view('exploitant.exploitant',compact('data'))->withSuccess("modification d'un exploitant ave succes");
    }
}
